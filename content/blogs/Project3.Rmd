---
title: "Analysis of Relationship Between Physical Activity and Weight of High Schoolers"
author: "Rasul Rasulov"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
---


```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```


```{r load-libraries, echo=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(GGally)
library(readxl)
library(here)
library(skimr)
library(janitor)
library(broom)
library(tidyquant)
library(infer)
library(openintro)
library(kableExtra)
library(scales)
```


# Youth Risk Behavior Surveillance

Every two years, the Centers for Disease Control and Prevention conduct the [Youth Risk Behavior Surveillance System (YRBSS)](https://www.cdc.gov/healthyyouth/data/yrbs/index.htm) survey, where it takes data from high schoolers (9th through 12th grade), to analyze health patterns. We work with a selected group of variables from a random sample of observations during one of the years the YRBSS was conducted.

## Load the data

This data is part of the `openintro` textbook and we can load and inspect it. There are observations on 13 different variables, some categorical and some numerical. 

```{r}
data(yrbss) # loading the data
glimpse(yrbss) #having a glimpse on the data
```

**(1) - We also decided to check with dataset with `skimr::skim()` to have an idea if there are any missing values. It is also indicative of summary statistics of numerical variables, and a very rough histogram, so it worth running**

```{r}

skim(yrbss) #using skim function to get an idea of the dataset

```

The table presented above indicates the extensive occurances of missing data. For "race" which scores the first in terms of the missing values, n_missing is above 2800.

## Exploratory Data Analysis

**(2) - Our work started with analyzing the `weight` of participants in kilograms. We have calculated summary statistics. We also built a distribution plot**

```{r}

weight_distribution <- yrbss %>% 
  select(weight) %>% #choosing weight variable
  filter(!is.na(weight)) %>% #filtering out missing data
  summarise(mean=mean(weight),SD=sd(weight),median=median(weight),min=min(weight),max=max(weight))
#calculating statistics

  weight_distribution #showing the calculations 
  
ggplot(yrbss,aes(x=weight)) + #building a plot
  geom_density()+ #choosing density plot
  labs(title="Distribution of weights appears to be roughly normal")+ #adding title
  xlab("Weight (kg)")+ #adding x-axis label
  theme_stata() #choosing theme


```
We are missing 1004 observations for the variable weight. The distribution of weights, as is shown on the diagram above, is right-skewed. However, it is still close to normal as it is roughly bell-shaped.

**(3) - Next, consider the possible relationship between a high schooler’s weight and their physical activity.**
  
```{r}

yrbss <- yrbss %>% 
  mutate(physical_3plus = ifelse(physically_active_7d >= 3, "yes", "no")) #creating new variable

yrbss %>% filter(!is.na(physical_3plus)) %>%  #filtering out missing data
  group_by(physical_3plus) %>% 
  #grouping by this new variable to calculate proportions based on its observations
  summarise(count=n()) %>% #counting the answers 
  mutate(prop=count/sum(count)) #calculating the proportions 

```
**(4) - Providing a 95% confidence interval for the population proportion of high schools that are *NOT* active 3 or more days per week**

```{r}

not_active_CI <- yrbss %>%
  specify(response = physical_3plus, success="no") %>% 
  #using bootstrap conf interval and choosing "no" as a reference for calculation
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "prop") #proportions

percentile_ci <- not_active_CI %>%
  get_ci(level = 0.95, type = "percentile") #choosing conf level

percentile_ci

```

```{r}

visualize(not_active_CI) + #plotting the graph
  shade_ci(endpoints = percentile_ci,fill = "light blue")+ #choosing shading
  geom_vline(xintercept = percentile_ci$lower_ci, colour = "red")+ #paining the contours
  geom_vline(xintercept = percentile_ci$upper_ci, colour = "red")+ #paining the contours
  theme_stata() #choosing the theme

```
**(5) - Making a boxplot of `physical_3plus` vs. `weight`. Checking if there is a relationship between these two variables**

```{r}

yrbss %>% 
  filter(!is.na(physical_3plus)) %>% 
ggplot(aes(x=physical_3plus,y=weight)) + geom_boxplot()+
  labs(title="The relationship between weight and physical activity")+
  theme_stata()


```
As shown by the box plot, the relationship between the two variables is present. This is intuitive as both the process of gaining weight and loosing weight is highly associated with physical activity. As to distribution of answes, we can see that the median weight is slightly higher for those who exercise, but outliers in "no" group with high weight are also present which proves that physical activity prevents some obscure cases of high weight. 

## Confidence Interval

**(6) - Boxplots show how the medians of the two distributions compare, but we can also compare the means of the distributions using either a confidence interval or a hypothesis test. We calculate the mean/SD, etc weight in these groups using the mean function, we must ignore any missing values by setting the `na.rm = TRUE`.**

```{r}

yrbss %>%
  group_by(physical_3plus) %>% 
  #grouping by physical activity as we test whether the weight differ 
  #for those who is invilved in physical activity and otherwise
  filter(!is.na(physical_3plus)) %>% #filtering out missing data
  summarise(mean_weight = mean(weight, na.rm = TRUE), #calculating necessary statistics
            sd_weight = sd(weight, na.rm=TRUE), #calculating necessary statistics
            count = n(),
            se_weight = sd_weight/sqrt(count), #calculating necessary statistics
            t_critical = qt(0.975, count-1), #calculating necessary statistics for 95% CI
            margin_of_error = t_critical * se_weight, #calculating necessary statistics
            lower = mean_weight - t_critical * se_weight, #calculating CI
            upper = mean_weight + t_critical * se_weight #calculating CI
            )

```
There is an observed difference of about 1.77kg (68.44 - 66.67), and we notice that the two confidence intervals do not overlap. It seems that the difference is at least 95% statistically significant. Let us also conduct a hypothesis test to make sure that two different methods result in the same outcome.

## Hypothesis test with formula

**(7) To conduct the test we need the null and alternative hypotheses (for testing whether mean weights are different for those who exercise at least times a week and those who don’t).**

H0: Mean weights of students who exercise 3 or more times a week = Mean weights of students who exercise who do not

H1: Mean weights of students who exercise 3 or more times a week != Mean weights of students who exercise who do not

```{r}
t.test(weight ~ physical_3plus, data = yrbss) #conducting t-test
```

## Hypothesis test with `infer`

**(8) - Next, we will introduce test with function `hypothesize`, that falls into the infer workflow. We need to initialize the test, which is saved later on as `obs_diff`.**

```{r}

obs_diff <- yrbss %>%
  specify(weight ~ physical_3plus) %>% #specifying the variable for which mean is 
  #calculated and the variable in which these means are going to differ
  calculate(stat = "diff in means", order = c("yes", "no")) #choosing the statistics: difference in means
#choosing order to satisfy the null hypothesis of yes - no != 0
obs_diff

```

**(9) - After we made the test, we need to simulate the test on the null distribution, which is later on saved as null.**

```{r}
null_dist <- yrbss %>%
  specify(weight ~ physical_3plus) %>% #specifying the variable for which mean is 
  #calculated and the variable in which these means are going to differ
  hypothesize(null = "independence") %>% #choosing test for independence as we 
  #are testing whether means are different
  generate(reps = 1000, type = "permute") %>% #permute is used to generate the 
  #null distribution for hypothesis test
  calculate(stat = "diff in means", order = c("yes", "no"))
null_dist

```


We use `hypothesize`  to set the null hypothesis as a test for independence - the test that there is no difference between the two population means.

We can visualize this null distribution with the following code:

```{r}
ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram(bins=20, fill="dark blue")+
  labs(title="The null distribution is normal")+
  theme_stata()
```

Now that the test is initialized and the null distribution formed, we can visualise to see how many of these null permutations have a difference of at least `obs_stat` of `r obs_diff %>% pull() %>% round(2)`

In order to make a decision we use p-value, which is plotted on the histogram below using the function get_p_value

```{r}

null_dist %>% visualize() +
  shade_p_value(obs_stat = obs_diff, direction = "two-sided")+
  theme_stata()

null_dist %>%
  get_p_value(obs_stat = obs_diff, direction = "two_sided")

```

Besides having confidence interval and boxplot indicating that there is significant difference in means, we anyways conducted the hypothesis testing to provide additional confidence in the result. After conducting the necessary steps to provide the test and using visalisation techniques we actually see the distribution under null hypothesis and see the p-value. The p-value being close to zero is a clear indication that the null hypothesis is being rejected, as t-stat>t-critical or significance level>p-value. So using three different approaches we managed to prove that there is a difference in mean weights for those are involved in physical activity 3 or more times per week. 
